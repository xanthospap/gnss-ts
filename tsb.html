<!DOCTYPE html>
<html lang="en">

<head><title>Metrics Graphics</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
    <link href='https://netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css' rel='stylesheet' type='text/css'>
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css' rel='stylesheet' type='text/css'>

    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.0/d3.min.js' charset='utf-8'></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    
    <!-- dev start -->
    <script src='metrics-graphics-2.9.0/src/js/MG.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/data_graphic.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/hooks.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/register.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/bootstrap_tooltip_popover.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/chart_title.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/y_axis.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/x_axis.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/init.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/markers.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/rollover.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/common/window_listeners.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/layout/bootstrap_dropdown.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/layout/button.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/charts/line.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/charts/histogram.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/charts/point.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/charts/bar.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/charts/table.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/charts/missing.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/misc/process.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/misc/smoothers.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/misc/formatters.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/misc/transitions.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/misc/utility.js'></script>
    <script src='metrics-graphics-2.9.0/src/js/misc/error.js'></script>
    <!-- dev end -->
    
    <link href='metrics-graphics-2.9.0/dist/metricsgraphics.css' rel='stylesheet' type='text/css' id='light'>
    
    <!-- mg-line-brushing addon https://github.com/dandehavilland/mg-line-brushing -->
    <script src='mg-line-brushing-master/dist/mg_line_brushing.js'></script>
    <link rel='stylesheet' href='mg-line-brushing-master/dist/mg_line_brushing.css' type="text/css"/>
</head>

<body>
<div class='container-fluid'>
    <div class='row'>
        <h2 id='header-string'>Position Time-Series for station </h2>
        <p>This should render, but it doesn't!</p>
    </div>
    
    <div class='row'>
        <div class='col-md-9 col-md-push-1' id='north'></div>
        <div class='col-md-1 btn-group btn-group-md' role='group'>
            <button type='button' class='btn btn-primary inactive' id='north-outlier-btn'>Filter Outliers</button>
            <button type='button' class='btn btn-primary inactive' id='north-chart-btn'>Line Plot</button>
        </div>
    </div><!-- row-->
    
    <div class='row'>
        <div class='col-md-9 col-md-push-1' id='east'></div>
        <div class='col-md-1 btn-group btn-group-md' role='group'>
            <button type='button' class='btn btn-primary inactive' id='east-outlier-btn'>Filter Outliers</button>
            <button type='button' class='btn btn-primary inactive' id='east-chart-btn'>Line Plot</button>
        </div>
    </div><!-- row-->
    
    <div class='row'>
        <div class='col-md-9 col-md-push-1' id='up'></div>
        <div class='col-md-1 btn-group btn-group-md' role='group'>
            <button type='button' class='btn btn-primary inactive' id='up-outlier-btn'>Filter Outliers</button>
            <button type='button' class='btn btn-primary inactive' id='up-chart-btn'>Line Plot</button>
        </div>
    </div><!-- row-->

</div><!-- container -->

<script>

/* deep copy an array */
function deepCopy(arr) {
    var out = [];
    for (var i = 0, len = arr.length; i < len; i++) {
        var item = arr[i];
        var obj = {};
        for (var k in item) {
            obj[k] = item[k];
        }
        out.push(obj);
    }
    return out;
}

var globals = {};
var plt_width = 800;

var north_plot = {
        title: "Time-Series (component: North)",
        description: "This is an example of a graphic with a confidence band and extended x-axis ticks enabled.",
        // data: data,
        animate_on_load: true,
        // format: 'percentage',
        width: plt_width,
        height: 400,
        right: 40,
        area: false,
        missing_is_hidden: true,
        target: '#north',
        y_accessor: 'north',
        show_secondary_x_label: false,
        show_confidence_band: ['ln', 'un'],
        x_extended_ticks: true,
        x_label: 'date',
        y_label: 'north (mm)',
        // yax_units: 'mm',
        least_squares: true,
        chart_type: 'point',
        // full_width: true
        // axes_not_compact: false
        // y_extended_ticks: true
        left: 100,
        linked: true,
};

var east_plot = {
        title: "Time-Series (component: East)",
        description: "This is an example of a graphic with a confidence band and extended x-axis ticks enabled.",
        // data: data,
        animate_on_load: true,
        // format: 'percentage',
        width: plt_width,
        height: 400,
        right: 40,
        area: false,
        missing_is_hidden: true,
        target: '#east',
        y_accessor: 'east',
        show_secondary_x_label: false,
        show_confidence_band: ['le', 'ue'],
        x_extended_ticks: true,
        x_label: 'date',
        y_label: 'east (mm)',
        // yax_units: 'mm',
        least_squares: true,
        chart_type: 'point',
        left: 100,
        linked: true,
        // full_width: true
};

var up_plot = {
        title: "Time-Series (component: Up)",
        description: "This is an example of a graphic with a confidence band and extended x-axis ticks enabled.",
        // data: data,
        animate_on_load: true,
        // format: 'percentage',
        width: plt_width,
        height: 400,
        right: 40,
        area: false,
        missing_is_hidden: true,
        target: '#up',
        y_accessor: 'up',
        show_secondary_x_label: false,
        show_confidence_band: ['lu', 'uu'],
        x_extended_ticks: true,
        x_label: 'date',
        y_label: 'up (mm)',
        // yax_units: 'mm',
        least_squares: true,
        chart_type: 'point',
        left: 100,
        linked: true,
        // full_width: true
};

d3.json('foo.json', function(data) {
    
    /* make clean_data; a 'deep' copy of data, with no outliers */
    var clean_data = deepCopy(data);
    var sz = data.length;
    while (sz--) {
        if ( data[sz]['flag'].indexOf('outlier') != -1 ) {
            clean_data.splice(sz, 1);
        }
    }

    /* format for MG and assign to global vars */
    data = MG.convert.date(data, 'date');
    filtered_data = MG.convert.date(clean_data, 'date');
    globals.data = data;
    globals.clean_data = filtered_data;
    
    /* plot original series, including outliers */
    north_plot.data = data;
    MG.data_graphic(north_plot);

    east_plot.data = data;
    MG.data_graphic(east_plot);
    
    up_plot.data = data;
    MG.data_graphic(up_plot);
});

/* given a component (north, east, up), remove outliers from the ts plot */
function filter_outliers(component) {
    if (component === 'north') {
        north_plot.data = globals.clean_data;
        MG.data_graphic(north_plot);
    } else if (component === 'east') {
        east_plot.data = globals.clean_data;
        MG.data_graphic(east_plot);
    } else {
        up_plot.data = globals.clean_data;
        MG.data_graphic(up_plot);
    }
};

/* given a component (north, east, up), insert outliers from the ts plot */
function reset_outliers(component) {
    if (component === 'north') {
        north_plot.data = globals.data;
        MG.data_graphic(north_plot);
    } else if (component === 'east') {
        east_plot.data = globals.data;
        MG.data_graphic(east_plot);
    } else {
        up_plot.data = globals.data;
        MG.data_graphic(up_plot);
    }
};

/* given a component (north, east, up), plot the ts as line */
function plot_ln(component) {
    var tmp_plot;
    if (component === 'north') {
        tmp_plot = north_plot;
    } else if (component === 'east') {
        tmp_plot = east_plot;
    } else {
        // up_plot.data = globals.data;
        // MG.data_graphic(up_plot);
        tmp_plot = up_plot;
    }
    tmp_plot.least_squares = false;
    tmp_plot.chart_type = 'line';
    MG.data_graphic(tmp_plot);
}

/* given a component (north, east, up), plot the ts as points */
function plot_pt(component) {
    var tmp_plot;
    if (component === 'north') {
        tmp_plot = north_plot;
    } else if (component === 'east') {
        tmp_plot = east_plot;
    } else {
        // up_plot.data = globals.data;
        // MG.data_graphic(up_plot);
        tmp_plot = up_plot;
    }
    tmp_plot.least_squares = true;
    tmp_plot.chart_type = 'point';
    MG.data_graphic(tmp_plot);
}

/* enable/disable north outliers button */
$( '#north-outlier-btn' ).on( 'click', function(event) {
    event.stopPropagation(); // prevent default bootstrap behavior
    if( $(this).attr('data-toggle') != 'button' ) { // don't toggle if data-toggle="button"
        $(this).toggleClass('active');
    }
    
    if ( $(this).hasClass( 'active' ) ) {
        filter_outliers('north');
    } else {
        reset_outliers('north');
    }
});

/* set north chart style button */
$( '#north-chart-btn' ).on( 'click', function(event) {
    event.stopPropagation(); // prevent default bootstrap behavior
    if( $(this).attr('data-toggle') != 'button' ) { // don't toggle if data-toggle="button"
        $(this).toggleClass('active');
    }
    
    if ( $(this).hasClass( 'active' ) ) {
        plot_ln('north');
    } else {
        plot_pt('north');
    }
});

/* enable/disable east outliers button */
$( '#east-outlier-btn' ).on( 'click', function(event) {
    event.stopPropagation(); // prevent default bootstrap behavior
    if( $(this).attr('data-toggle') != 'button' ) { // don't toggle if data-toggle="button"
        $(this).toggleClass('active');
    }
    
    if ( $(this).hasClass( 'active' ) ) {
        filter_outliers('east');
    } else {
        reset_outliers('east');
    }
});

/* set east chart style button */
$( '#east-chart-btn' ).on( 'click', function(event) {
    event.stopPropagation(); // prevent default bootstrap behavior
    if( $(this).attr('data-toggle') != 'button' ) { // don't toggle if data-toggle="button"
        $(this).toggleClass('active');
    }
    
    if ( $(this).hasClass( 'active' ) ) {
        plot_ln('east');
    } else {
        plot_pt('east');
    }
});

/* enable/disable up outliers button */
$( '#up-outlier-btn' ).on( 'click', function(event) {
    event.stopPropagation(); // prevent default bootstrap behavior
    if( $(this).attr('data-toggle') != 'button' ) { // don't toggle if data-toggle="button"
        $(this).toggleClass('active');
    }
    
    if ( $(this).hasClass( 'active' ) ) {
        filter_outliers('up');
    } else {
        reset_outliers('up');
    }
});

/* set up chart style button */
$( '#up-chart-btn' ).on( 'click', function(event) {
    event.stopPropagation(); // prevent default bootstrap behavior
    if( $(this).attr('data-toggle') != 'button' ) { // don't toggle if data-toggle="button"
        $(this).toggleClass('active');
    }
    
    if ( $(this).hasClass( 'active' ) ) {
        plot_ln('up');
    } else {
        plot_pt('up');
    }
});
</script>

</body>
</html>
